<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="utf-8"/>
<title>Pixel Multiplayer - Verbeterd</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<style>
  :root{
    --panel: rgba(20,20,20,0.95);
    --muted: #bdbdbd;
    --accent: #ffd54f;
    --danger: #ff5252;
  }
  html,body{height:100%;margin:0;background:#0b0b0b;color:#fff;font-family:Inter,Arial,system-ui;}
  canvas{display:block;background:#1b262b;cursor:crosshair;}
  /* Topbar */
  #topbar{position:fixed;left:0;top:0;right:0;height:48px;display:flex;align-items:center;padding:6px 12px;background:rgba(0,0,0,0.8);z-index:2000;gap:14px;backdrop-filter: blur(5px);border-bottom:1px solid rgba(255,255,255,0.1);}
  #topbar .muted{color:var(--muted);font-size:13px}
  /* modal */
  .modal{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);min-width:320px;max-width:90vw;max-height:90vh;overflow:auto;background:var(--panel);padding:20px;border-radius:12px;border:1px solid rgba(255,255,255,0.1);z-index:3000;display:none;box-shadow: 0 10px 30px rgba(0,0,0,0.5);}
  .modal h2{margin:0 0 15px 0;color:var(--accent);border-bottom:1px solid rgba(255,255,255,0.1);padding-bottom:8px;}
  .row{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;}
  .slot{width:70px;height:70px;border-radius:8px;background:#151515;border:2px solid rgba(255,255,255,0.1);display:flex;align-items:flex-end;padding:6px;box-sizing:border-box;cursor:pointer;background-size:cover;background-position:center;transition: all 0.2s ease;position:relative;}
  .slot:hover{transform: translateY(-3px); border-color: var(--accent);}
  .slot.selected{outline:3px solid var(--accent); transform: scale(1.08); box-shadow: 0 5px 15px rgba(255,213,79,0.3);}
  button,input[type=text],input[type=number],select{background:#1a1a1a;border:1px solid rgba(255,255,255,0.1);color:white;padding:10px 14px;border-radius:8px;transition: all 0.2s ease;font-size:14px;}
  button:hover{background:#252525;border-color: var(--accent);}
  button:active{transform: scale(0.98);}
  .small{font-size:13px;color:var(--muted);}
  /* admin */
  #adminPanel{position:fixed;right:15px;top:60px;background:var(--panel);padding:16px;border-radius:10px;border:1px solid rgba(255,255,255,0.1);z-index:3000;display:none;min-width:260px;box-shadow: 0 5px 20px rgba(0,0,0,0.4);}
  #clanPanel{position:fixed;left:15px;top:60px;background:var(--panel);padding:16px;border-radius:10px;border:1px solid rgba(255,255,255,0.1);z-index:3000;display:none;min-width:280px;max-height:70vh;overflow:auto;box-shadow: 0 5px 20px rgba(0,0,0,0.4);}
  .clan-item{padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.08);margin-bottom:10px;background:#151515;transition: all 0.2s ease;}
  .clan-item:hover{background:#1a1a1a; border-color: rgba(255,255,255,0.15);}
  .tooltip{position:fixed;pointer-events:none;padding:8px 12px;background:#000c;border:1px solid rgba(255,255,255,0.1);border-radius:8px;display:none;z-index:4000;backdrop-filter: blur(5px);font-size:13px;}
  
  /* New styles */
  .section-title{font-weight:600;margin:15px 0 8px 0;font-size:14px;color:var(--accent);}
  .danger-zone{border-top:1px solid rgba(255,100,100,0.2);padding-top:12px;margin-top:12px;}
  .danger-btn{background:var(--danger);color:white;border-color:var(--danger);}
  .success-btn{background:#4CAF50;color:white;border-color:#4CAF50;}
  .flex-between{display:flex;justify-content:space-between;align-items:center;gap:10px;}
  .notification{position:fixed;top:20px;right:20px;padding:12px 16px;background:var(--panel);border-radius:8px;border-left:4px solid var(--accent);z-index:5000;display:none;box-shadow: 0 5px 15px rgba(0,0,0,0.3);font-size:14px;}
  .stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:15px;}
  .stat-item{background:rgba(255,255,255,0.05);padding:8px 12px;border-radius:6px;font-size:12px;}
  .block-indicator{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:var(--panel);padding:8px 16px;border-radius:20px;border:1px solid rgba(255,255,255,0.1);font-size:13px;display:none;z-index:1000;}
  .admin-badge{background:var(--accent);color:#000;padding:2px 6px;border-radius:4px;font-size:11px;font-weight:bold;margin-left:8px;}
</style>
</head>
<body>

<canvas id="game"></canvas>

<div id="topbar">
  <div id="playerLabel">Naam: ?</div>
  <div id="clanLabel" class="muted">Clan: -</div>
  <div style="flex:1"></div>
  <div id="coords" class="muted">X:0 Y:0</div>
  <div id="online" class="muted">Online: 0</div>
  <div id="selectedInfo" class="muted" style="display:none;">Geselecteerd: -</div>
</div>

<!-- Block Indicator -->
<div class="block-indicator" id="blockIndicator">
  <span id="currentBlock">Geen blok geselecteerd</span>
</div>

<!-- Notification System -->
<div class="notification" id="notification"></div>

<!-- Inventory Modal -->
<div class="modal" id="inventoryModal">
  <h2>üì¶ Inventory</h2>
  <div class="row" id="inventorySlots"></div>
  <div class="stats-grid">
    <div class="stat-item">Geselecteerd: <span id="selectedBlockName">-</span></div>
    <div class="stat-item">Blokken: <span id="blocksPlaced">0</span></div>
  </div>
  <div style="margin-top:15px" class="small">
    <div>üîº E = Open/Sluit inventory</div>
    <div>üñ±Ô∏è Klik = Plaats blok</div>
    <div>üñ±Ô∏è Rechtsklik = Verwijder blok</div>
    <div>üîß Shift+Klik = Verwijder zonder selectie</div>
  </div>
  <div style="text-align:right;margin-top:15px"><button id="invClose">Sluiten</button></div>
</div>

<!-- Clan & First-time Modal -->
<div class="modal" id="firstModal">
  <h2>üéÆ Welkom bij Pixel Multiplayer</h2>
  <div class="small">Kies je bijnaam en clan om te beginnen</div>
  <div style="height:10px"></div>
  <input id="nickInput" type="text" placeholder="Je bijnaam" style="width:100%" maxlength="20"/>
  <div style="height:15px"></div>
  <div class="section-title">üè¥ Kies een clan</div>
  <div class="small">Join een bestaande clan of maak een nieuwe</div>
  <div id="clanList" style="margin-top:10px;max-height:200px;overflow:auto"></div>
  <div style="height:10px"></div>
  <div class="flex-between">
    <input id="newClanInput" type="text" placeholder="Nieuwe clan naam" style="flex:1" maxlength="15"/>
    <button id="createClanBtn">Maak Clan</button>
  </div>
  <div style="text-align:right;margin-top:15px"><button id="firstDoneBtn" class="success-btn">Start Spelen ‚Üí</button></div>
</div>

<!-- Admin Panel -->
<div id="adminPanel">
  <div style="font-weight:700;margin-bottom:10px;color:var(--accent);display:flex;align-items:center;">
    ‚ö° Admin Panel
    <span class="admin-badge">u_yqrok</span>
  </div>

  <div class="section-title">üë• Speler Beheer</div>
  <div style="margin-bottom:10px">
    <select id="adminPlayerSelect" style="width:100%">
      <option value="">Selecteer speler...</option>
    </select>
  </div>

  <div style="display:flex;gap:8px;margin-bottom:10px">
    <div style="flex:1">
      <label class="small">Grootte</label>
      <input id="adminChangeSize" type="number" min="16" max="128" value="32" class="small" />
    </div>
    <div style="flex:1">
      <label class="small">Snelheid</label>
      <input id="adminChangeSpeed" type="number" min="1" max="20" value="4" step="0.5" class="small" />
    </div>
  </div>

  <div style="margin-bottom:10px">
    <label class="small">Kleur</label>
    <input id="adminChangeColor" type="color" value="#ff4444" style="width:100%" />
  </div>

  <div style="display:flex;gap:8px;align-items:center;margin-bottom:12px">
    <label class="small"><input id="adminTrack" type="checkbox"/> Volg speler</label>
    <button id="adminApplyBtn" style="flex:1">Toepassen</button>
  </div>

  <div style="display:flex;gap:8px;margin-bottom:10px">
    <button id="adminKickBtn" style="flex:1;background:#7a1f1f">üö´ Kick</button>
    <button id="adminTeleportBtn" style="flex:1">üîÆ Teleport</button>
  </div>

  <div class="danger-zone">
    <div class="small" style="color:var(--danger);">‚ö†Ô∏è Gevaarlijke Zone</div>
    <div style="display:flex;gap:8px;margin-top:10px">
      <input id="resetConfirm" placeholder='typ "RESET"' style="flex:1" class="small"/>
      <button id="resetBtn" class="danger-btn">üí• Reset DB</button>
    </div>
  </div>
</div>

<!-- Clan Panel -->
<div id="clanPanel" style="display:none">
  <div style="font-weight:700;margin-bottom:10px;color:var(--accent);">üè¥ Clans</div>
  <div id="clanPanelList" style="max-height:50vh;overflow:auto"></div>
  <div style="height:10px"></div>
  <div style="text-align:right"><button id="clanCloseBtn">Sluiten</button></div>
</div>

<div class="tooltip" id="tooltip" style="display:none"></div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

<script>
/* ================= Configuration ================= */
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyBUgFsK2D_QQtMUQGu-GdMjj8FEeDRE9dA",
  authDomain: "zever-7eca0.firebaseapp.com",
  databaseURL: "https://zever-7eca0-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "zever-7eca0"
};
firebase.initializeApp(FIREBASE_CONFIG);
const db = firebase.database();

/* ================= Globals & Textures ================= */
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
let W = innerWidth, H = innerHeight;
canvas.width = W; canvas.height = H;
window.addEventListener('resize', ()=>{ W = innerWidth; H = innerHeight; canvas.width = W; canvas.height = H; });

const tileSize = 32;
let camX = 0, camY = 0;

const adminId = 'u_yqrok';

// Eenvoudige texture system - gebruik kleuren als fallback
const BLOCKS = [
  {id: 'floor', name: 'Vloer', color: '#4a4a4a', solid: false},
  {id: 'wood',  name: 'Hout',  color: '#8B4513', solid: false},
  {id: 'wall',  name: 'Muur',  color: '#666666', solid: true},
  {id: 'grass', name: 'Gras',  color: '#2E8B57', solid: false},
  {id: 'carpet', name: 'Tapijt', color: '#8B4513', solid: false},
  {id: 'blood', name: 'Bloed', color: '#8B0000', solid: false}
];

/* UI refs */
const playerLabel = document.getElementById('playerLabel');
const clanLabel = document.getElementById('clanLabel');
const coordsLabel = document.getElementById('coords');
const onlineLabel = document.getElementById('online');
const selectedInfo = document.getElementById('selectedInfo');
const tooltip = document.getElementById('tooltip');
const notification = document.getElementById('notification');
const selectedBlockName = document.getElementById('selectedBlockName');
const blocksPlaced = document.getElementById('blocksPlaced');
const blockIndicator = document.getElementById('blockIndicator');
const currentBlock = document.getElementById('currentBlock');

const invModal = document.getElementById('inventoryModal');
const invSlots = document.getElementById('inventorySlots');
const invClose = document.getElementById('invClose');

const firstModal = document.getElementById('firstModal');
const nickInput = document.getElementById('nickInput');
const clanListEl = document.getElementById('clanList');
const newClanInput = document.getElementById('newClanInput');
const createClanBtn = document.getElementById('createClanBtn');
const firstDoneBtn = document.getElementById('firstDoneBtn');

const adminPanel = document.getElementById('adminPanel');
const adminPlayerSelect = document.getElementById('adminPlayerSelect');
const adminChangeSize = document.getElementById('adminChangeSize');
const adminChangeSpeed = document.getElementById('adminChangeSpeed');
const adminChangeColor = document.getElementById('adminChangeColor');
const adminTrack = document.getElementById('adminTrack');
const adminApplyBtn = document.getElementById('adminApplyBtn');
const adminKickBtn = document.getElementById('adminKickBtn');
const adminTeleportBtn = document.getElementById('adminTeleportBtn');
const resetConfirm = document.getElementById('resetConfirm');
const resetBtn = document.getElementById('resetBtn');

const clanPanel = document.getElementById('clanPanel');
const clanPanelList = document.getElementById('clanPanelList');
const clanCloseBtn = document.getElementById('clanCloseBtn');

/* runtime state */
let keys = {};
window.addEventListener('keydown', e=>{ keys[e.key] = true; });
window.addEventListener('keyup', e=>{ keys[e.key] = false; });

let local = { id: null, nickname: null, clan: null };
let player = null;
let players = {};
let mapTiles = {};
let clans = {};

let selectedBlock = null;
let blocksPlacedCount = 0;

/* ================= Firebase listeners ================= */
db.ref('players').on('value', snap=>{
  players = snap.val() || {};
  onlineLabel.innerText = 'Online: ' + Object.keys(players).length;
  rebuildAdminPlayerList();
});

db.ref('map').on('value', snap=>{
  mapTiles = snap.val() || {};
  blocksPlacedCount = Object.keys(mapTiles).length;
  if(blocksPlaced) blocksPlaced.innerText = blocksPlacedCount;
});

db.ref('clans').on('value', snap=>{
  clans = snap.val() || {};
  updateClanPanelList();
  if(firstModal.style.display !== 'none') buildFirstModalClanList();
});

/* ================= Utility helpers ================= */
function worldKey(tx,ty){ return tx + ',' + ty; }
function show(el){ el.style.display = 'block'; }
function hide(el){ el.style.display = 'none'; }
function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }

function showNotification(message, duration = 3000) {
  notification.innerText = message;
  show(notification);
  setTimeout(() => {
    hide(notification);
  }, duration);
}

/* ================= Inventory UI ================= */
function buildInventoryUI(){
  invSlots.innerHTML = '';
  BLOCKS.forEach(b=>{
    const s = document.createElement('div');
    s.className = 'slot';
    s.style.backgroundColor = b.color;
    s.title = b.name + (b.solid ? ' (SOLIDE)' : '');
    
    // Maak een eenvoudige textuur met canvas
    const textureCanvas = document.createElement('canvas');
    textureCanvas.width = 64;
    textureCanvas.height = 64;
    const texCtx = textureCanvas.getContext('2d');
    
    // Basis kleur
    texCtx.fillStyle = b.color;
    texCtx.fillRect(0, 0, 64, 64);
    
    // Textuur effect
    if(b.id === 'wood') {
      texCtx.fillStyle = '#A0522D';
      for(let i = 0; i < 8; i++) {
        texCtx.fillRect(i * 8, 0, 4, 64);
      }
    } else if(b.id === 'wall') {
      texCtx.fillStyle = '#555';
      for(let x = 0; x < 8; x++) {
        for(let y = 0; y < 8; y++) {
          if((x + y) % 2 === 0) {
            texCtx.fillRect(x * 8, y * 8, 4, 4);
          }
        }
      }
    } else if(b.id === 'grass') {
      texCtx.fillStyle = '#3CB371';
      for(let i = 0; i < 20; i++) {
        const x = Math.random() * 64;
        const y = Math.random() * 64;
        texCtx.fillRect(x, y, 2, 8);
      }
    } else if(b.id === 'carpet') {
      texCtx.fillStyle = '#A0522D';
      texCtx.fillRect(0, 0, 64, 64);
      texCtx.fillStyle = '#8B4513';
      for(let i = 0; i < 4; i++) {
        texCtx.fillRect(i * 16, 0, 8, 64);
      }
    } else if(b.id === 'blood') {
      texCtx.fillStyle = '#8B0000';
      texCtx.fillRect(0, 0, 64, 64);
      texCtx.fillStyle = '#660000';
      // Maak bloedvlekken
      for(let i = 0; i < 5; i++) {
        const x = 10 + Math.random() * 44;
        const y = 10 + Math.random() * 44;
        const r = 5 + Math.random() * 10;
        texCtx.beginPath();
        texCtx.arc(x, y, r, 0, Math.PI * 2);
        texCtx.fill();
      }
    }
    
    s.style.backgroundImage = `url(${textureCanvas.toDataURL()})`;
    
    s.onclick = ()=>{
      if(selectedBlock && selectedBlock.id === b.id){
        selectedBlock = null;
        s.classList.remove('selected');
        selectedBlockName.innerText = '-';
        hide(blockIndicator);
        hide(selectedInfo);
      } else {
        selectedBlock = b;
        invSlots.querySelectorAll('.slot').forEach(x => x.classList.remove('selected'));
        s.classList.add('selected');
        selectedBlockName.innerText = b.name;
        currentBlock.innerText = b.name;
        show(blockIndicator);
        show(selectedInfo);
        selectedInfo.innerText = `Geselecteerd: ${b.name}`;
      }
    };
    
    const label = document.createElement('div');
    label.style.fontSize='11px'; label.style.color='white'; label.style.textShadow='0 1px 2px black';
    label.style.background='rgba(0,0,0,0.7)'; label.style.padding='2px 4px'; label.style.borderRadius='3px';
    label.innerText = b.name;
    s.appendChild(label);
    invSlots.appendChild(s);
  });
}

invClose.addEventListener('click', ()=>{ 
  hide(invModal); 
  if(selectedBlock) {
    show(blockIndicator);
  }
});

/* ================= First-time setup ================= */
function isFirstTime(){ return !localStorage.getItem('nickname'); }

function buildFirstModalClanList(){
  clanListEl.innerHTML = '';
  const keys = Object.keys(clans || {});
  if(keys.length === 0){
    const p = document.createElement('div'); 
    p.className='small muted'; 
    p.innerText = 'Nog geen clans. Maak de eerste!';
    p.style.padding='10px';
    p.style.textAlign='center';
    clanListEl.appendChild(p);
    return;
  }
  
  keys.sort((a,b)=>a.localeCompare(b, undefined, {sensitivity:'base'}));
  keys.forEach(name=>{
    const box = document.createElement('div');
    box.className = 'clan-item';
    const t = document.createElement('div'); 
    t.style.fontWeight='700'; 
    t.innerText = name;
    const c = document.createElement('div'); 
    c.className='muted small'; 
    c.innerText = 'Leden: ' + (clans[name].members ? Object.keys(clans[name].members).length : 0);
    const btn = document.createElement('button'); 
    btn.style.marginTop='8px'; 
    btn.innerText='Join Clan';
    btn.onclick = ()=> {
      joinClan(name);
    };
    box.appendChild(t); 
    box.appendChild(c); 
    box.appendChild(btn);
    clanListEl.appendChild(box);
  });
}

createClanBtn.addEventListener('click', async ()=>{
  const name = newClanInput.value.trim();
  if(!name) return showNotification('Voer een clan naam in', 2000);
  
  const existing = Object.keys(clans || {}).find(c => c.toLowerCase() === name.toLowerCase());
  if(existing) return showNotification('Clan bestaat al!', 3000);
  
  if(!local.id){
    local.clan = name;
    localStorage.setItem('clan', name);
    showNotification('Clan wordt aangemaakt!');
    return;
  }
  
  await db.ref('clans/' + name + '/members/' + local.id).set({ 
    name: local.nickname || 'Speler', 
    joinedAt: Date.now() 
  });
  
  local.clan = name;
  localStorage.setItem('clan', name);
  if(player){ 
    player.clan = name; 
    db.ref('players/' + local.id + '/clan').set(name); 
  }
  
  showNotification('Clan aangemaakt! Je bent nu lid.');
  buildFirstModalClanList();
  newClanInput.value = '';
});

firstDoneBtn.addEventListener('click', ()=>{
  const nick = nickInput.value.trim();
  if(!nick) return showNotification('Voer een bijnaam in!', 3000);
  
  local.nickname = nick;
  localStorage.setItem('nickname', nick);
  
  if(local.clan) localStorage.setItem('clan', local.clan);
  
  hide(firstModal);
  startOrUpdatePlayer();
});

/* ================= Player Management ================= */
async function startOrUpdatePlayer(){
  if(localStorage.getItem('playerId')) {
    local.id = localStorage.getItem('playerId');
  } else { 
    local.id = 'u_' + Math.random().toString(36).substr(2,6); 
    localStorage.setItem('playerId', local.id); 
  }

  if(!local.nickname) local.nickname = localStorage.getItem('nickname') || ('Speler' + Math.floor(Math.random()*9999));
  if(!local.clan) local.clan = localStorage.getItem('clan') || null;

  player = {
    px: 200, py: 200, x: 6, y: 6,
    speed: 4, w: 32, h: 32,
    color: '#ff4444',
    name: local.nickname,
    clan: local.clan || null
  };

  await db.ref('players/' + local.id).set(player);
  db.ref('players/' + local.id).onDisconnect().remove();

  if(local.clan) {
    db.ref('clans/' + local.clan + '/members/' + local.id).set({ 
      name: local.nickname, 
      joinedAt: Date.now() 
    });
  }

  updateLabels();
  showNotification(`Welkom ${local.nickname}!`, 2000);
  requestAnimationFrame(mainLoop);
}

function updateLabels(){
  playerLabel.innerText = 'Naam: ' + (player.clan ? '[' + player.clan + '] ' : '') + player.name;
  clanLabel.innerText = 'Clan: ' + (player.clan || '-');
}

/* ================= Building System ================= */
function tileOccupiedByPlayer(tx,ty){
  for(const id in players){
    const p = players[id];
    if(!p || typeof p.px === 'undefined') continue;
    const centerX = Math.floor((p.px + (p.w || 32) / 2) / tileSize);
    const centerY = Math.floor((p.py + (p.h || 32) / 2) / tileSize);
    if(centerX === tx && centerY === ty) return true;
  }
  if(player){
    const lcx = Math.floor((player.px + player.w/2) / tileSize);
    const lcy = Math.floor((player.py + player.h/2) / tileSize);
    if(lcx === tx && lcy === ty) return true;
  }
  return false;
}

function screenToTile(mx,my){
  const worldX = mx - camX;
  const worldY = my - camY;
  return { 
    tx: Math.floor(worldX / tileSize), 
    ty: Math.floor(worldY / tileSize) 
  };
}

/* Place block on left click */
canvas.addEventListener('click', (ev)=>{
  if(!player || !selectedBlock) return;
  
  const rect = canvas.getBoundingClientRect();
  const mx = ev.clientX - rect.left, my = ev.clientY - rect.top;
  const {tx,ty} = screenToTile(mx,my);
  const key = worldKey(tx,ty);
  
  if(mapTiles[key]) { 
    showNotification('Er staat al een blok hier!', 1500); 
    return; 
  }
  
  if(tileOccupiedByPlayer(tx,ty)) { 
    showNotification('Speler staat hier!', 1500); 
    return; 
  }
  
  db.ref('map/' + key).set({ type: selectedBlock.id });
  showNotification(`${selectedBlock.name} geplaatst!`, 1500);
});

/* Remove block on right-click */
canvas.addEventListener('contextmenu', (ev)=>{
  ev.preventDefault();
  if(!player) return;
  
  const rect = canvas.getBoundingClientRect();
  const mx = ev.clientX - rect.left, my = ev.clientY - rect.top;
  const {tx,ty} = screenToTile(mx,my);
  const key = worldKey(tx,ty);
  
  if(mapTiles[key]) {
    db.ref('map/' + key).remove();
    showNotification('Blok verwijderd!', 1500);
  }
});

/* Remove block with shift+click */
canvas.addEventListener('click', (ev)=>{
  if(ev.shiftKey){ 
    const rect = canvas.getBoundingClientRect();
    const mx = ev.clientX - rect.left, my = ev.clientY - rect.top;
    const {tx,ty} = screenToTile(mx,my);
    const key = worldKey(tx,ty);
    
    if(mapTiles[key]) {
      db.ref('map/' + key).remove();
      showNotification('Blok verwijderd!', 1500);
    }
  }
});

/* ================= Collision Detection ================= */
function isSolidAt(tx,ty){
  const key = worldKey(tx,ty);
  const tile = mapTiles[key];
  if(!tile) return false;
  const b = BLOCKS.find(bb => bb.id === tile.type);
  return b ? b.solid : false;
}

function collidesAt(px,py){
  const corners = [
    {x: px, y: py},
    {x: px + player.w - 1, y: py},
    {x: px, y: py + player.h - 1},
    {x: px + player.w - 1, y: py + player.h - 1}
  ];
  
  for(const c of corners){
    const tx = Math.floor(c.x / tileSize);
    const ty = Math.floor(c.y / tileSize);
    if(isSolidAt(tx,ty)) return true;
  }
  return false;
}

/* ================= Admin System ================= */
function rebuildAdminPlayerList(){
  adminPlayerSelect.innerHTML = '<option value="">Selecteer speler...</option>';
  const ids = Object.keys(players).sort();
  
  ids.forEach(id=>{
    const opt = document.createElement('option');
    opt.value = id;
    const p = players[id];
    const label = p && p.name ? p.name : id;
    opt.text = (id === local.id ? '[JIJ] ' : '') + label;
    adminPlayerSelect.appendChild(opt);
  });
}

adminApplyBtn.addEventListener('click', async ()=>{
  if(local.id !== adminId) return showNotification('Alleen admin!', 2000);
  
  const sel = adminPlayerSelect.value;
  if(!sel) return showNotification('Selecteer een speler!', 2000);
  
  const newSize = parseInt(adminChangeSize.value) || players[sel].w;
  const newSpeed = parseFloat(adminChangeSpeed.value) || players[sel].speed;
  const newColor = adminChangeColor.value || players[sel].color;
  
  await db.ref('players/' + sel).update({ 
    w: newSize, 
    h: newSize, 
    speed: newSpeed, 
    color: newColor 
  });
  
  showNotification('Speler aangepast!', 2000);
});

adminKickBtn.addEventListener('click', async ()=>{
  if(local.id !== adminId) return showNotification('Alleen admin!', 2000);
  
  const sel = adminPlayerSelect.value;
  if(!sel) return showNotification('Selecteer een speler!', 2000);
  
  if(!confirm(`Weet je zeker dat je ${sel} wilt kicken?`)) return;
  
  await db.ref('players/' + sel).remove();
  
  if(sel === local.id) {
    showNotification('Je bent gekicked! Pagina herladen...', 2000);
    setTimeout(() => location.reload(), 2000);
  } else {
    showNotification('Speler gekicked!', 2000);
  }
});

adminTeleportBtn.addEventListener('click', async ()=>{
  if(local.id !== adminId) return showNotification('Alleen admin!', 2000);
  
  const sel = adminPlayerSelect.value;
  if(!sel) return showNotification('Selecteer een speler!', 2000);
  
  const p = players[sel];
  if(!p) return showNotification('Speler niet gevonden!', 2000);
  
  player.px = p.px || 0;
  player.py = p.py || 0;
  
  await db.ref('players/' + local.id).update({ 
    px: player.px, 
    py: player.py 
  });
  
  showNotification(`Geteleporteerd naar ${sel}!`, 2000);
});

resetBtn.addEventListener('click', async ()=>{
  if(local.id !== adminId) return showNotification('Alleen admin!', 2000);
  
  const code = resetConfirm.value.trim();
  if(code !== 'RESET') return showNotification('Typ "RESET" om te bevestigen!', 2000);
  
  if(!confirm('WEET JE HET ZEKER? Alles wordt verwijderd!')) return;
  
  try{
    await db.ref('players').remove();
    await db.ref('map').remove();
    await db.ref('clans').remove();
    
    resetConfirm.value = '';
    showNotification('Database gereset!', 3000);
    
    if(player) await db.ref('players/' + local.id).set(player);
  }catch(err){
    showNotification('Error: ' + err.message, 3000);
  }
});

/* ================= Clan System ================= */
function updateClanPanelList(){
  clanPanelList.innerHTML = '';
  const names = Object.keys(clans || {});
  
  if(names.length === 0){
    const p = document.createElement('div'); 
    p.className='small'; 
    p.innerText = 'Nog geen clans.';
    p.style.padding='10px';
    p.style.textAlign='center';
    clanPanelList.appendChild(p);
    return;
  }
  
  names.sort((a,b)=>a.localeCompare(b, undefined, {sensitivity:'base'}));
  
  names.forEach(name=>{
    const el = document.createElement('div'); 
    el.className = 'clan-item';
    
    const title = document.createElement('div'); 
    title.style.fontWeight='700'; 
    title.innerText = name;
    
    const members = clans[name].members ? Object.keys(clans[name].members) : [];
    const memCount = document.createElement('div'); 
    memCount.className='small muted'; 
    memCount.innerText = members.length + ' leden';
    
    const btnJoin = document.createElement('button'); 
    btnJoin.style.marginTop='8px'; 
    btnJoin.innerText='Join Clan';
    
    btnJoin.onclick = async ()=> {
      if(!local.id) return showNotification('Wacht even...', 2000);
      
      await db.ref('clans/' + name + '/members/' + local.id).set({ 
        name: local.nickname || player.name, 
        joinedAt: Date.now() 
      });
      
      local.clan = name; 
      localStorage.setItem('clan', name);
      
      if(player) { 
        player.clan = name; 
        db.ref('players/' + local.id + '/clan').set(name); 
      }
      
      showNotification(`Je bent lid van ${name}!`, 2000);
      updateLabels();
      updateClanPanelList();
    };
    
    el.appendChild(title); 
    el.appendChild(memCount); 
    el.appendChild(btnJoin);
    clanPanelList.appendChild(el);
  });
}

clanCloseBtn.addEventListener('click', ()=> hide(clanPanel));

/* ================= Controls ================= */
window.addEventListener('keydown', (e)=>{
  if(e.key === 'e' || e.key === 'E'){
    e.preventDefault();
    if(invModal.style.display === 'block') {
      hide(invModal);
      if(selectedBlock) show(blockIndicator);
    } else { 
      buildInventoryUI(); 
      show(invModal); 
      hide(blockIndicator);
    }
  } 
  else if(e.key === 'c' || e.key === 'C'){
    e.preventDefault();
    if(clanPanel.style.display === 'block') hide(clanPanel); 
    else { updateClanPanelList(); show(clanPanel); }
  }
  else if(e.key === 'Tab'){
    e.preventDefault();
    if(local.id === adminId) {
      adminPanel.style.display = adminPanel.style.display === 'block' ? 'none' : 'block';
    }
  }
  else if(e.key === 'Escape') {
    if(invModal.style.display === 'block') hide(invModal);
    if(clanPanel.style.display === 'block') hide(clanPanel);
    if(adminPanel.style.display === 'block') hide(adminPanel);
    if(selectedBlock) show(blockIndicator);
  }
});

/* ================= Main Game Loop ================= */
function mainLoop(){
  if(!player) { requestAnimationFrame(mainLoop); return; }
  
  let vx = 0, vy = 0;
  const sp = player.speed;
  
  if(keys['ArrowUp'] || keys['w']) vy -= sp;
  if(keys['ArrowDown'] || keys['s']) vy += sp;
  if(keys['ArrowLeft'] || keys['a']) vx -= sp;
  if(keys['ArrowRight'] || keys['d']) vx += sp;
  
  const intendedX = player.px + vx;
  const intendedY = player.py + vy;
  
  if(!collidesAt(intendedX, player.py)) player.px = intendedX;
  if(!collidesAt(player.px, intendedY)) player.py = intendedY;
  
  player.x = Math.floor((player.px + player.w/2) / tileSize);
  player.y = Math.floor((player.py + player.h/2) / tileSize);
  
  db.ref('players/' + local.id).update({ 
    px: player.px, 
    py: player.py, 
    x: player.x, 
    y: player.y 
  });
  
  camX = W/2 - player.px;
  camY = H/2 - player.py;
  
  ctx.fillStyle = '#1b2a2b';
  ctx.fillRect(0,0,W,H);
  
  const startTx = Math.floor((-camX) / tileSize) - 2;
  const endTx = Math.floor((W - camX) / tileSize) + 2;
  const startTy = Math.floor((-camY) / tileSize) - 2;
  const endTy = Math.floor((H - camY) / tileSize) + 2;
  
  for(let tx = startTx; tx <= endTx; tx++){
    for(let ty = startTy; ty <= endTy; ty++){
      const key = worldKey(tx,ty);
      const tile = mapTiles[key];
      
      if(tile){
        const b = BLOCKS.find(bb => bb.id === tile.type);
        if(b) {
          ctx.fillStyle = b.color;
          ctx.fillRect(tx*tileSize + camX, ty*tileSize + camY, tileSize, tileSize);
          
          // Textuur effecten
          if(b.id === 'wood') {
            ctx.fillStyle = '#A0522D';
            for(let i = 0; i < 4; i++) {
              ctx.fillRect(tx*tileSize + camX + i * 8, ty*tileSize + camY, 4, tileSize);
            }
          } else if(b.id === 'wall') {
            ctx.fillStyle = '#555';
            for(let x = 0; x < 4; x++) {
              for(let y = 0; y < 4; y++) {
                if((x + y) % 2 === 0) {
                  ctx.fillRect(tx*tileSize + camX + x * 8, ty*tileSize + camY + y * 8, 4, 4);
                }
              }
            }
          } else if(b.id === 'grass') {
            ctx.fillStyle = '#3CB371';
            for(let i = 0; i < 8; i++) {
              const x = tx*tileSize + camX + Math.random() * tileSize;
              const y = ty*tileSize + camY + Math.random() * tileSize;
              ctx.fillRect(x, y, 1, 4);
            }
          }
        }
      } else {
        ctx.fillStyle = '#2E8B57';
        ctx.fillRect(tx*tileSize + camX, ty*tileSize + camY, tileSize, tileSize);
      }
    }
  }
  
  for(const id in players){
    const p = players[id];
    if(!p) continue;
    
    const pw = p.w || 32, ph = p.h || 32;
    const drawX = (p.px || 0) + camX;
    const drawY = (p.py || 0) + camY;
    
    ctx.fillStyle = p.color || '#44a';
    ctx.fillRect(drawX, drawY, pw, ph);
    
    const displayName = (p.clan ? '[' + p.clan + '] ' : '') + (p.name || 'Speler');
    ctx.fillStyle = 'white'; 
    ctx.font = '12px sans-serif'; 
    ctx.textAlign = 'center';
    ctx.fillText(displayName, drawX + pw/2, drawY - 8);
    
    if(local.id === adminId && adminTrack.checked && id !== local.id){
      ctx.strokeStyle = 'yellow'; 
      ctx.setLineDash([5, 5]);
      ctx.beginPath();
      ctx.moveTo(player.px + camX + player.w/2, player.py + camY + player.h/2);
      ctx.lineTo(drawX + pw/2, drawY + ph/2); 
      ctx.stroke();
      ctx.setLineDash([]);
    }
  }
  
  ctx.fillStyle = player.color;
  ctx.fillRect(player.px + camX, player.py + camY, player.w, player.h);
  
  ctx.fillStyle='white'; 
  ctx.font='12px sans-serif'; 
  ctx.textAlign='center';
  ctx.fillText((player.clan ? '['+player.clan+'] ' : '') + player.name, 
               player.px + camX + player.w/2, player.py + camY - 8);
  
  coordsLabel.innerText = `X:${player.x} Y:${player.y}`;
  
  requestAnimationFrame(mainLoop);
}

/* ================= Join Clan Function ================= */
function joinClan(name){
  local.clan = name; 
  localStorage.setItem('clan', name);
  
  if(local.id){
    db.ref('clans/' + name + '/members/' + local.id).set({ 
      name: local.nickname || player.name, 
      joinedAt: Date.now() 
    });
    
    if(player){ 
      player.clan = name; 
      db.ref('players/' + local.id + '/clan').set(name); 
    }
    
    showNotification(`Je bent lid van ${name}!`, 2000);
    updateLabels();
  } else {
    showNotification('Clan wordt ingesteld...', 3000);
  }
}

/* ================= Startup ================= */
function init(){
  buildInventoryUI();
  selectedBlock = null;
  
  if(isFirstTime()){
    show(firstModal);
    nickInput.focus();
  } else {
    local.nickname = localStorage.getItem('nickname');
    local.clan = localStorage.getItem('clan') || null;
    startOrUpdatePlayer();
  }
  
  showNotification('Gebruik E voor inventory, C voor clans, Tab voor admin', 5000);
}

init();

</script>
</body>
</html>
