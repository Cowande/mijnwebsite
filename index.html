<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="utf-8"/>
<title>Pixel Multiplayer - Admin & Clans (Improved)</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<style>
  :root{
    --panel: rgba(10,10,10,0.95);
    --muted: #bdbdbd;
    --accent: #ffd54f;
    --danger: #ff5252;
    --success: #69f0ae;
  }
  html,body{height:100%;margin:0;background:#0b0b0b;color:#fff;font-family:Inter,Arial,system-ui;}
  canvas{display:block;background:#1b262b;}
  /* Topbar */
  #topbar{position:fixed;left:0;top:0;right:0;height:48px;display:flex;align-items:center;padding:6px 12px;background:rgba(0,0,0,0.7);z-index:2000;gap:14px;backdrop-filter: blur(5px);}
  #topbar .muted{color:var(--muted);font-size:13px}
  /* modal */
  .modal{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);min-width:320px;max-width:90vw;max-height:90vh;overflow:auto;background:var(--panel);padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,0.08);z-index:3000;display:none;box-shadow: 0 10px 30px rgba(0,0,0,0.5);}
  .modal h2{margin:0 0 12px 0;color:var(--accent);}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  .slot{width:72px;height:72px;border-radius:8px;background:#0c0c0c;border:2px solid rgba(255,255,255,0.08);display:flex;align-items:flex-end;padding:6px;box-sizing:border-box;cursor:pointer;background-size:cover;background-position:center;transition: all 0.2s ease;}
  .slot:hover{transform: translateY(-2px); border-color: rgba(255,255,255,0.2);}
  .slot.selected{outline:3px solid var(--accent); transform: scale(1.05);}
  button,input[type=text],input[type=number],select{background:#0d0d0d;border:1px solid rgba(255,255,255,0.08);color:white;padding:8px 12px;border-radius:6px;transition: all 0.2s ease;}
  button:hover{background:#151515;border-color: rgba(255,255,255,0.15);}
  button:active{transform: scale(0.98);}
  .small{font-size:13px}
  /* admin */
  #adminPanel{position:fixed;right:12px;top:64px;background:var(--panel);padding:14px;border-radius:10px;border:1px solid rgba(255,255,255,0.08);z-index:3000;display:none;min-width:240px;box-shadow: 0 5px 15px rgba(0,0,0,0.3);}
  #clanPanel{position:fixed;left:12px;top:64px;background:var(--panel);padding:14px;border-radius:10px;border:1px solid rgba(255,255,255,0.08);z-index:3000;display:none;min-width:280px;max-height:60vh;overflow:auto;box-shadow: 0 5px 15px rgba(0,0,0,0.3);}
  #playerSettings{position:fixed;left:12px;bottom:12px;background:var(--panel);padding:14px;border-radius:10px;border:1px solid rgba(255,255,255,0.08);z-index:3000;display:none;min-width:240px;box-shadow: 0 5px 15px rgba(0,0,0,0.3);}
  .clan-item{padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);margin-bottom:10px;background:#0b0b0b;transition: all 0.2s ease;}
  .clan-item:hover{background:#111; border-color: rgba(255,255,255,0.1);}
  .tooltip{position:fixed;pointer-events:none;padding:8px 12px;background:#000c;border:1px solid rgba(255,255,255,0.08);border-radius:8px;display:none;z-index:4000;backdrop-filter: blur(5px);}
  
  /* New styles for improved UI */
  .section-title{font-weight:600;margin:12px 0 6px 0;font-size:14px;color:var(--accent);}
  .danger-zone{border-top:1px solid rgba(255,255,255,0.08);padding-top:12px;margin-top:12px;}
  .danger-btn{background:var(--danger);color:white;}
  .success-btn{background:var(--success);color:#000;}
  .flex-between{display:flex;justify-content:space-between;align-items:center;}
  .notification{position:fixed;top:20px;right:20px;padding:12px 16px;background:var(--panel);border-radius:8px;border-left:4px solid var(--accent);z-index:5000;display:none;box-shadow: 0 5px 15px rgba(0,0,0,0.3);}
  .stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:10px;}
  .stat-item{background:rgba(255,255,255,0.05);padding:6px 10px;border-radius:6px;font-size:12px;}
  .player-settings-row{display:flex;gap:6px;margin-bottom:8px;align-items:center;}
  .player-settings-row label{min-width:60px;}
</style>
</head>
<body>

<canvas id="game"></canvas>

<div id="topbar">
  <div id="playerLabel">Naam: ?</div>
  <div id="clanLabel" class="muted">Clan: -</div>
  <div style="flex:1"></div>
  <div id="coords" class="muted">X:0 Y:0</div>
  <div id="online" class="muted">Online: 0</div>
  <button id="settingsToggle" style="padding:4px 8px;font-size:12px;">Instellingen</button>
</div>

<!-- Notification System -->
<div class="notification" id="notification"></div>

<!-- Inventory Modal -->
<div class="modal" id="inventoryModal">
  <h2>Inventory</h2>
  <div class="row" id="inventorySlots"></div>
  <div class="stats-grid">
    <div class="stat-item">Geselecteerd: <span id="selectedBlockName">-</span></div>
    <div class="stat-item">Blokken geplaatst: <span id="blocksPlaced">0</span></div>
  </div>
  <div style="margin-top:12px" class="small muted">E to open/close. Klik om te selecteren (klik opnieuw om te deselect). Shift+klik/Right-click op wereld om te verwijderen.</div>
  <div style="text-align:right;margin-top:14px"><button id="invClose">Sluiten</button></div>
</div>

<!-- Clan & First-time Modal -->
<div class="modal" id="firstModal">
  <h2>Welkom â€” Kies je bijnaam & clan</h2>
  <div class="small muted">Je bijnaam wordt opgeslagen en kan later alleen door admin worden aangepast.</div>
  <div style="height:8px"></div>
  <input id="nickInput" type="text" placeholder="Je bijnaam" style="width:100%"/>
  <div style="height:10px"></div>
  <div class="section-title">Kies een clan</div>
  <div class="small muted">Kies een bestaande clan of maak een nieuwe (clannamen zijn uniek, case-insensitive).</div>
  <div id="clanList" style="margin-top:8px;max-height:200px;overflow:auto"></div>
  <div style="height:8px"></div>
  <div class="flex-between">
    <input id="newClanInput" type="text" placeholder="Nieuwe clan naam" style="width:60%"/>
    <button id="createClanBtn">Maak clan</button>
  </div>
  <div style="text-align:right;margin-top:14px"><button id="firstDoneBtn" class="success-btn">Klaar</button></div>
</div>

<!-- Admin Panel -->
<div id="adminPanel">
  <div style="font-weight:700;margin-bottom:8px;color:var(--accent);">Admin (u_yqrok)</div>

  <div class="section-title">Speler beheer</div>
  <div style="margin-bottom:8px">
    <label class="small">Selecteer speler</label>
    <select id="adminPlayerSelect" style="width:100%"></select>
  </div>

  <div style="margin-bottom:8px">
    <label class="small">Naam (admin kan wijzigen)</label>
    <input id="adminChangeName" type="text" class="small" />
  </div>

  <div style="display:flex;gap:6px;margin-bottom:8px">
    <div style="flex:1">
      <label class="small">Grootte</label><br/>
      <input id="adminChangeSize" type="number" min="16" max="128" class="small" />
    </div>
    <div style="flex:1">
      <label class="small">Snelheid</label><br/>
      <input id="adminChangeSpeed" type="number" min="1" max="30" class="small" />
    </div>
  </div>

  <div style="margin-bottom:8px">
    <label class="small">Kleur</label><br/>
    <input id="adminChangeColor" type="color" />
  </div>

  <div style="display:flex;gap:6px;align-items:center;margin-bottom:10px">
    <label class="small"><input id="adminTrack" type="checkbox"/> Track speler</label>
    <button id="adminApplyBtn" style="flex:1">Toepassen</button>
  </div>

  <div style="display:flex;gap:6px;margin-bottom:8px">
    <button id="adminKickBtn" style="flex:1;background:#5a1f1f">Kick</button>
    <button id="adminTeleportBtn" style="flex:1">Teleporteer</button>
  </div>

  <div class="danger-zone">
    <div class="small muted" style="color:var(--danger);">Gevaarlijke zone</div>
    <div style="display:flex;gap:6px;margin-top:8px">
      <input id="resetConfirm" placeholder='typ "RESET" om te bevestigen' style="flex:1"/>
      <button id="resetBtn" class="danger-btn">Reset DB</button>
    </div>
  </div>
</div>

<!-- Player Settings Panel -->
<div id="playerSettings">
  <div style="font-weight:700;margin-bottom:8px;color:var(--accent);">Speler Instellingen</div>
  
  <div class="player-settings-row">
    <label class="small">Grootte</label>
    <input id="playerChangeSize" type="number" min="16" max="128" class="small" style="flex:1" />
  </div>
  
  <div class="player-settings-row">
    <label class="small">Snelheid</label>
    <input id="playerChangeSpeed" type="number" min="1" max="30" step="0.5" class="small" style="flex:1" />
  </div>
  
  <div class="player-settings-row">
    <label class="small">Kleur</label>
    <input id="playerChangeColor" type="color" style="flex:1" />
  </div>
  
  <div style="text-align:right;margin-top:8px">
    <button id="playerApplyBtn">Toepassen</button>
  </div>
</div>

<!-- Clan Panel (toggle with C) -->
<div id="clanPanel" style="display:none">
  <div style="font-weight:700;margin-bottom:8px;color:var(--accent);">Clans</div>
  <div id="clanPanelList" style="max-height:40vh;overflow:auto"></div>
  <div style="height:8px"></div>
  <div style="text-align:right"><button id="clanCloseBtn">Sluiten</button></div>
</div>

<div class="tooltip" id="tooltip" style="display:none"></div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

<script>
/* ================= Configuration ================= */
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyBUgFsK2D_QQtMUQGu-GdMjj8FEeDRE9dA",
  authDomain: "zever-7eca0.firebaseapp.com",
  databaseURL: "https://zever-7eca0-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "zever-7eca0"
};
firebase.initializeApp(FIREBASE_CONFIG);
const db = firebase.database();

/* ================= Globals & Textures ================= */
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
let W = innerWidth, H = innerHeight;
canvas.width = W; canvas.height = H;
window.addEventListener('resize', ()=>{ W = innerWidth; H = innerHeight; canvas.width = W; canvas.height = H; });

const tileSize = 32;
let camX = 0, camY = 0;

const adminId = 'u_yqrok';

const tex = {};
['floor','wall','wood','grass','player','carpet','blood'].forEach(k=>{
  tex[k] = new Image();
  tex[k].src = k + '.png';
  // Fallback voor ontbrekende textures
  tex[k].onerror = function() {
    console.warn('Texture niet gevonden: ' + k + '.png');
  };
});

const BLOCKS = [
  {id: 'floor', name: 'Vloer', tex: 'floor', solid: false, placeOn: []},
  {id: 'wood',  name: 'Hout',  tex: 'wood',  solid: false, placeOn: ['floor', 'grass']},
  {id: 'wall',  name: 'Muur',  tex: 'wall',  solid: true, placeOn: ['floor', 'grass']},
  {id: 'grass', name: 'Grass', tex: 'grass', solid: false, placeOn: []},
  {id: 'carpet', name: 'Tapijt', tex: 'carpet', solid: false, placeOn: ['floor']},
  {id: 'blood', name: 'Bloed', tex: 'blood', solid: false, placeOn: ['floor', 'grass']}
];

/* UI refs */
const playerLabel = document.getElementById('playerLabel');
const clanLabel = document.getElementById('clanLabel');
const coordsLabel = document.getElementById('coords');
const onlineLabel = document.getElementById('online');
const tooltip = document.getElementById('tooltip');
const notification = document.getElementById('notification');
const selectedBlockName = document.getElementById('selectedBlockName');
const blocksPlaced = document.getElementById('blocksPlaced');
const settingsToggle = document.getElementById('settingsToggle');

const invModal = document.getElementById('inventoryModal');
const invSlots = document.getElementById('inventorySlots');
const invClose = document.getElementById('invClose');

const firstModal = document.getElementById('firstModal');
const nickInput = document.getElementById('nickInput');
const clanListEl = document.getElementById('clanList');
const newClanInput = document.getElementById('newClanInput');
const createClanBtn = document.getElementById('createClanBtn');
const firstDoneBtn = document.getElementById('firstDoneBtn');

const adminPanel = document.getElementById('adminPanel');
const adminPlayerSelect = document.getElementById('adminPlayerSelect');
const adminChangeName = document.getElementById('adminChangeName');
const adminChangeSize = document.getElementById('adminChangeSize');
const adminChangeSpeed = document.getElementById('adminChangeSpeed');
const adminChangeColor = document.getElementById('adminChangeColor');
const adminTrack = document.getElementById('adminTrack');
const adminApplyBtn = document.getElementById('adminApplyBtn');
const adminKickBtn = document.getElementById('adminKickBtn');
const adminTeleportBtn = document.getElementById('adminTeleportBtn');
const resetConfirm = document.getElementById('resetConfirm');
const resetBtn = document.getElementById('resetBtn');

const playerSettings = document.getElementById('playerSettings');
const playerChangeSize = document.getElementById('playerChangeSize');
const playerChangeSpeed = document.getElementById('playerChangeSpeed');
const playerChangeColor = document.getElementById('playerChangeColor');
const playerApplyBtn = document.getElementById('playerApplyBtn');

const clanPanel = document.getElementById('clanPanel');
const clanPanelList = document.getElementById('clanPanelList');
const clanCloseBtn = document.getElementById('clanCloseBtn');

/* runtime state */
let keys = {};
window.addEventListener('keydown', e=>{ keys[e.key] = true; });
window.addEventListener('keyup', e=>{ keys[e.key] = false; });

let local = { id: null, nickname: null, clan: null };
let player = null;     // local player's runtime object
let players = {};      // firebase snapshot
let mapTiles = {};     // firebase snapshot (map keyed by "x,y")
let clans = {};        // firebase snapshot

let selectedBlock = null; // nothing in-hand by default
let blocksPlacedCount = 0;

/* ================= Firebase listeners ================= */
db.ref('players').on('value', snap=>{
  players = snap.val() || {};
  onlineLabel.innerText = 'Online: ' + Object.keys(players).length;
  rebuildAdminPlayerList();
});
db.ref('map').on('value', snap=>{
  mapTiles = snap.val() || {};
  // Update blocks placed count
  blocksPlacedCount = Object.keys(mapTiles).length;
  if(blocksPlaced) blocksPlaced.innerText = blocksPlacedCount;
});
db.ref('clans').on('value', snap=>{
  clans = snap.val() || {};
  updateClanPanelList();
  if(firstModal.style.display !== 'none') buildFirstModalClanList();
});

/* ================= Utility helpers ================= */
function worldKey(tx,ty){ return tx + ',' + ty; }
function show(el){ el.style.display = 'block'; }
function hide(el){ el.style.display = 'none'; }
function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }

function showNotification(message, duration = 3000) {
  notification.innerText = message;
  show(notification);
  setTimeout(() => {
    hide(notification);
  }, duration);
}

/* ================= Inventory UI ================= */
function buildInventoryUI(){
  invSlots.innerHTML = '';
  BLOCKS.forEach(b=>{
    const s = document.createElement('div');
    s.className = 'slot';
    s.style.backgroundImage = `url(${b.tex}.png)`;
    s.title = b.name + (b.placeOn.length > 0 ? `\nPlaatsbaar op: ${b.placeOn.join(', ')}` : '');
    s.onclick = ()=>{
      if(selectedBlock && selectedBlock.id === b.id){
        selectedBlock = null;
        s.classList.remove('selected');
        selectedBlockName.innerText = '-';
      } else {
        selectedBlock = b;
        invSlots.querySelectorAll('.slot').forEach(x => x.classList.remove('selected'));
        s.classList.add('selected');
        selectedBlockName.innerText = b.name;
      }
    };
    const label = document.createElement('div');
    label.style.fontSize='12px'; label.style.color='white'; label.style.textShadow='0 1px 2px black';
    label.innerText = b.name;
    s.appendChild(label);
    invSlots.appendChild(s);
  });
}
invClose.addEventListener('click', ()=>{ hide(invModal); });

/* ================= First-time nickname & clan ================= */
function isFirstTime(){ return !localStorage.getItem('nickname'); }

function buildFirstModalClanList(){
  clanListEl.innerHTML = '';
  const keys = Object.keys(clans || {});
  if(keys.length === 0){
    const p = document.createElement('div'); p.className='small muted'; p.innerText = 'Nog geen clans. Maak de eerste!';
    clanListEl.appendChild(p);
    return;
  }
  keys.sort((a,b)=>a.localeCompare(b, undefined, {sensitivity:'base'}));
  keys.forEach(name=>{
    const box = document.createElement('div');
    box.className = 'clan-item';
    const t = document.createElement('div'); t.style.fontWeight='700'; t.innerText = name;
    const c = document.createElement('div'); c.className='muted small'; c.innerText = 'Leden: ' + (clans[name].members ? Object.keys(clans[name].members).length : 0);
    const btn = document.createElement('button'); btn.style.marginTop='6px'; btn.innerText='Join';
    btn.onclick = ()=> {
      // join
      if(!local.id) alert('Wacht even, speler niet klaar'); // shouldn't happen
      else joinClan(name);
      showNotification('Je zult de clan joinen zodra je klaar bent.');
    };
    box.appendChild(t); box.appendChild(c); box.appendChild(btn);
    clanListEl.appendChild(box);
  });
}

createClanBtn.addEventListener('click', async ()=>{
  const name = newClanInput.value.trim();
  if(!name) return showNotification('Voer een clan naam in', 2000);
  // check duplicates case-insensitive
  const existing = Object.keys(clans || {}).find(c => c.toLowerCase() === name.toLowerCase());
  if(existing) return showNotification('Die clan bestaat al (case-insensitive). Kies een andere naam.', 3000);
  // create
  if(!local.id){
    // store choice locally for after player creation
    local.clan = name;
    localStorage.setItem('clan', name);
    showNotification('Clan wordt aangemaakt zodra je klaar bent.');
    return;
  }
  await db.ref('clans/' + name + '/members/' + local.id).set({ name: local.nickname || 'Speler', joinedAt: Date.now() });
  local.clan = name;
  localStorage.setItem('clan', name);
  if(player){ player.clan = name; db.ref('players/' + local.id + '/clan').set(name); }
  showNotification('Clan aangemaakt en je bent lid.');
  buildFirstModalClanList();
});

firstDoneBtn.addEventListener('click', ()=>{
  const nick = nickInput.value.trim();
  if(!nick) return showNotification('Voer een bijnaam in (je kunt deze later niet zelf veranderen).', 3000);
  local.nickname = nick;
  localStorage.setItem('nickname', nick);
  // if local.clan is set (via create earlier) ensure it's stored
  if(local.clan) localStorage.setItem('clan', local.clan);
  hide(firstModal);
  startOrUpdatePlayer();
});

/* ================= Player init and update ================= */
async function startOrUpdatePlayer(){
  // id
  if(localStorage.getItem('playerId')) local.id = localStorage.getItem('playerId');
  else { local.id = 'u_' + Math.random().toString(36).substr(2,6); localStorage.setItem('playerId', local.id); }

  if(!local.nickname) local.nickname = localStorage.getItem('nickname') || ('Speler' + Math.floor(Math.random()*9999));
  if(!local.clan) local.clan = localStorage.getItem('clan') || null;

  player = {
    px: 0, py: 0, x: 0, y: 0,
    speed: 4, w: 32, h: 32,
    color: '#ff4444',
    name: local.nickname,
    clan: local.clan || null
  };

  // write to firebase & ensure remove on disconnect
  await db.ref('players/' + local.id).set(player);
  db.ref('players/' + local.id).onDisconnect().remove();

  // if clan set, ensure member registered
  if(local.clan) db.ref('clans/' + local.clan + '/members/' + local.id).set({ name: local.nickname, joinedAt: Date.now() });

  // show labels
  updateLabels();
  showNotification('Welkom ' + local.nickname + '!', 2000);
  
  // Update player settings form
  if(playerChangeSize) playerChangeSize.value = player.w;
  if(playerChangeSpeed) playerChangeSpeed.value = player.speed;
  if(playerChangeColor) playerChangeColor.value = player.color;
  
  requestAnimationFrame(mainLoop);
}

function updateLabels(){
  playerLabel.innerText = 'Naam: ' + (player.clan ? '[' + player.clan + '] ' : '') + player.name;
  clanLabel.innerText = 'Clan: ' + (player.clan || '-');
}

/* ================= Placement rules ================= */
function tileOccupiedByPlayer(tx,ty){
  for(const id in players){
    const p = players[id];
    if(!p || typeof p.px === 'undefined') continue;
    const centerX = Math.floor((p.px + (p.w || 32) / 2) / tileSize);
    const centerY = Math.floor((p.py + (p.h || 32) / 2) / tileSize);
    if(centerX === tx && centerY === ty) return true;
  }
  if(player){
    const lcx = Math.floor((player.px + player.w/2) / tileSize);
    const lcy = Math.floor((player.py + player.h/2) / tileSize);
    if(lcx === tx && lcy === ty) return true;
  }
  return false;
}

function screenToTile(mx,my){
  // camX,camY defined as: camX = W/2 - player.px; so worldX = mx - camX
  const worldX = mx - camX;
  const worldY = my - camY;
  return { tx: Math.floor(worldX / tileSize), ty: Math.floor(worldY / tileSize) };
}

/* place block on click (left) if inventory selected */
canvas.addEventListener('click', (ev)=>{
  if(!player || !selectedBlock) return;
  const rect = canvas.getBoundingClientRect();
  const mx = ev.clientX - rect.left, my = ev.clientY - rect.top;
  const {tx,ty} = screenToTile(mx,my);
  const key = worldKey(tx,ty);
  
  // Check if there's already a block
  if(mapTiles[key]) { 
    showNotification('Er staat al een blok op die plek.', 1500); 
    return; 
  }
  
  // Check if block can be placed on this tile type
  const baseTileKey = worldKey(tx, ty);
  const baseTile = mapTiles[baseTileKey];
  
  // If there's no base tile, it's grass
  const baseType = baseTile ? baseTile.type : 'grass';
  
  // Check if selected block can be placed on this base type
  if(selectedBlock.placeOn.length > 0 && !selectedBlock.placeOn.includes(baseType)) {
    showNotification(`Kan ${selectedBlock.name} niet plaatsen op ${baseType}.`, 2000);
    return;
  }
  
  if(tileOccupiedByPlayer(tx,ty)) { 
    showNotification('Kan hier geen blok zetten: speler aanwezig.', 1500); 
    return; 
  }
  
  // place
  db.ref('map/' + key).set({ type: selectedBlock.id });
  showNotification(selectedBlock.name + ' geplaatst op ' + tx + ',' + ty, 1500);
});

/* remove block on right-click or shift+click */
canvas.addEventListener('contextmenu', (ev)=>{
  ev.preventDefault();
  if(!player) return;
  const rect = canvas.getBoundingClientRect();
  const mx = ev.clientX - rect.left, my = ev.clientY - rect.top;
  const {tx,ty} = screenToTile(mx,my);
  const key = worldKey(tx,ty);
  if(mapTiles[key]) {
    db.ref('map/' + key).remove();
    showNotification('Blok verwijderd van ' + tx + ',' + ty, 1500);
  }
});
canvas.addEventListener('click', (ev)=>{
  if(ev.shiftKey && selectedBlock === null){ // shift+click with empty hand deletes
    const rect = canvas.getBoundingClientRect();
    const mx = ev.clientX - rect.left, my = ev.clientY - rect.top;
    const {tx,ty} = screenToTile(mx,my);
    const key = worldKey(tx,ty);
    if(mapTiles[key]) {
      db.ref('map/' + key).remove();
      showNotification('Blok verwijderd van ' + tx + ',' + ty, 1500);
    }
  }
});

/* ================= Collision logic ================= */
function isSolidAt(tx,ty){
  const key = worldKey(tx,ty);
  const tile = mapTiles[key];
  if(!tile) return false;
  const b = BLOCKS.find(bb => bb.id === tile.type);
  return b ? !!b.solid : false;
}

/* check full AABB corners */
function collidesAt(px,py){
  const corners = [
    {x: px, y: py},
    {x: px + player.w - 1, y: py},
    {x: px, y: py + player.h - 1},
    {x: px + player.w - 1, y: py + player.h - 1}
  ];
  for(const c of corners){
    const tx = Math.floor(c.x / tileSize);
    const ty = Math.floor(c.y / tileSize);
    if(isSolidAt(tx,ty)) return true;
  }
  return false;
}

/* ================= Admin UI actions ================= */
function rebuildAdminPlayerList(){
  // populate adminPlayerSelect
  const cur = adminPlayerSelect.value;
  adminPlayerSelect.innerHTML = '';
  const ids = Object.keys(players).sort();
  ids.forEach(id=>{
    const opt = document.createElement('option');
    opt.value = id;
    const label = players[id] && players[id].name ? players[id].name : id;
    opt.text = (id === local.id ? '[YOU] ' : '') + label + ' (' + id + ')';
    adminPlayerSelect.appendChild(opt);
  });
  if(cur) adminPlayerSelect.value = cur;
}

adminApplyBtn.addEventListener('click', async ()=>{
  if(local.id !== adminId) return showNotification('Alleen admin kan dit doen.', 2000);
  const sel = adminPlayerSelect.value;
  if(!sel) return showNotification('Selecteer een speler.', 2000);
  const newName = adminChangeName.value.trim();
  const newSize = parseInt(adminChangeSize.value) || undefined;
  const newSpeed = parseFloat(adminChangeSpeed.value) || undefined;
  const newColor = adminChangeColor.value || undefined;
  const update = {};
  if(newName) update.name = newName;
  if(newSize) { update.w = newSize; update.h = newSize; }
  if(newSpeed) update.speed = newSpeed;
  if(newColor) update.color = newColor;
  if(Object.keys(update).length === 0) return showNotification('Niets om te veranderen.', 2000);
  await db.ref('players/' + sel).update(update);
  showNotification('Speler bijgewerkt.', 2000);
});

adminKickBtn.addEventListener('click', async ()=>{
  if(local.id !== adminId) return showNotification('Alleen admin kan dit doen.', 2000);
  const sel = adminPlayerSelect.value;
  if(!sel) return showNotification('Selecteer speler', 2000);
  if(!confirm('Kick speler ' + sel + ' ?')) return;
  
  // Remove from Firebase
  await db.ref('players/' + sel).remove();
  
  // If kicking yourself, reload the page
  if(sel === local.id) {
    showNotification('Je bent gekicked. Pagina wordt herladen...', 2000);
    setTimeout(() => {
      window.location.reload();
    }, 2000);
  } else {
    showNotification('Speler verwijderd uit DB (gekicked).', 2000);
  }
});

adminTeleportBtn.addEventListener('click', async ()=>{
  if(local.id !== adminId) return showNotification('Alleen admin kan dit doen.', 2000);
  const sel = adminPlayerSelect.value;
  if(!sel) return showNotification('Selecteer speler', 2000);
  const p = players[sel];
  if(!p) return showNotification('Speler data niet gevonden.', 2000);
  // teleport admin to that player's position
  player.px = p.px || p.x * tileSize || 0;
  player.py = p.py || p.y * tileSize || 0;
  await db.ref('players/' + local.id).update({ px: player.px, py: player.py });
  showNotification('Geteleporteerd naar ' + sel, 2000);
});

resetBtn.addEventListener('click', async ()=>{
  if(local.id !== adminId) return showNotification('Alleen admin kan DB resetten.', 2000);
  const code = resetConfirm.value.trim();
  if(code !== 'RESET') return showNotification('Type EXACT "RESET" in het veld om te bevestigen.', 2000);
  if(!confirm('Weet je zeker? Dit verwijdert players, map en clans in de database.')) return;
  try{
    await db.ref('players').remove();
    await db.ref('map').remove();
    await db.ref('clans').remove();
    resetConfirm.value = '';
    showNotification('Database nodes verwijderd (players, map, clans).', 3000);
    // re-create local player entry
    if(player) await db.ref('players/' + local.id).set(player);
  }catch(err){
    showNotification('Reset failed: ' + err.message, 3000);
  }
});

/* ================= Player Settings ================= */
settingsToggle.addEventListener('click', () => {
  if(playerSettings.style.display === 'block') {
    hide(playerSettings);
  } else {
    // Update form with current values
    playerChangeSize.value = player.w;
    playerChangeSpeed.value = player.speed;
    playerChangeColor.value = player.color;
    show(playerSettings);
  }
});

playerApplyBtn.addEventListener('click', async () => {
  if(!player) return;
  
  const newSize = parseInt(playerChangeSize.value) || player.w;
  const newSpeed = parseFloat(playerChangeSpeed.value) || player.speed;
  const newColor = playerChangeColor.value || player.color;
  
  // Apply changes locally
  player.w = newSize;
  player.h = newSize;
  player.speed = newSpeed;
  player.color = newColor;
  
  // Update in Firebase
  await db.ref('players/' + local.id).update({ 
    w: player.w, 
    h: player.h, 
    speed: player.speed, 
    color: player.color 
  });
  
  showNotification('Speler instellingen bijgewerkt!', 2000);
});

/* ================= Clan Panel UI ================= */
function updateClanPanelList(){
  clanPanelList.innerHTML = '';
  const names = Object.keys(clans || {});
  names.sort((a,b)=>a.localeCompare(b, undefined, {sensitivity:'base'}));
  if(names.length === 0){
    const p = document.createElement('div'); p.className='small'; p.innerText = 'Nog geen clans.';
    clanPanelList.appendChild(p);
    return;
  }
  names.forEach(name=>{
    const el = document.createElement('div'); el.className = 'clan-item';
    const title = document.createElement('div'); title.style.fontWeight='700'; title.innerText = name;
    const members = clans[name].members ? Object.keys(clans[name].members) : [];
    const memCount = document.createElement('div'); memCount.className='small muted'; memCount.innerText = 'Leden: ' + members.length;
    const btnJoin = document.createElement('button'); btnJoin.style.marginTop='6px'; btnJoin.innerText='Join';
    btnJoin.onclick = async ()=> {
      if(!local.id) return showNotification('Wacht even tot je bent aangemaakt.', 2000);
      // add to clan
      await db.ref('clans/' + name + '/members/' + local.id).set({ name: local.nickname || player.name, joinedAt: Date.now() });
      local.clan = name; localStorage.setItem('clan', name);
      if(player) { player.clan = name; db.ref('players/' + local.id + '/clan').set(name); }
      showNotification('Joined clan ' + name, 2000);
      updateLabels();
      updateClanPanelList();
    };
    el.appendChild(title); el.appendChild(memCount); el.appendChild(btnJoin);
    clanPanelList.appendChild(el);
  });
}
clanCloseBtn.addEventListener('click', ()=> hide(clanPanel));

/* ================= Controls: open inventory/clan/admin ================= */
window.addEventListener('keydown', (e)=>{
  if(e.key === 'e' || e.key === 'E'){
    if(invModal.style.display === 'block') hide(invModal);
    else { buildInventoryUI(); show(invModal); }
  } else if(e.key === 'c' || e.key === 'C'){
    if(clanPanel.style.display === 'block') hide(clanPanel); else { updateClanPanelList(); show(clanPanel); }
  } else if(e.key === 'Tab'){
    e.preventDefault();
    if(local.id === adminId) adminPanel.style.display = adminPanel.style.display === 'block' ? 'none' : 'block';
    else clanPanel.style.display = clanPanel.style.display === 'block' ? 'none' : 'block';
  } else if(e.key === 'p' || e.key === 'P') {
    // Toggle player settings panel
    if(playerSettings.style.display === 'block') {
      hide(playerSettings);
    } else {
      playerChangeSize.value = player.w;
      playerChangeSpeed.value = player.speed;
      playerChangeColor.value = player.color;
      show(playerSettings);
    }
  }
});

/* ================= Movement & main loop ================= */
function mainLoop(){
  if(!player) { requestAnimationFrame(mainLoop); return; }
  // intended movement
  let vx = 0, vy = 0;
  const sp = player.speed;
  if(keys['ArrowUp'] || keys['w']) vy -= sp;
  if(keys['ArrowDown'] || keys['s']) vy += sp;
  if(keys['ArrowLeft'] || keys['a']) vx -= sp;
  if(keys['ArrowRight'] || keys['d']) vx += sp;

  // per-axis try move to prevent corner gliding
  const intendedX = player.px + vx;
  const intendedY = player.py + vy;

  // try X
  if(!collidesAt(intendedX, player.py)) player.px = intendedX;
  // try Y
  if(!collidesAt(player.px, intendedY)) player.py = intendedY;

  // update grid coords as center tile
  player.x = Math.floor((player.px + player.w/2) / tileSize);
  player.y = Math.floor((player.py + player.h/2) / tileSize);

  // write lightweight update
  db.ref('players/' + local.id).update({ px: player.px, py: player.py, x: player.x, y: player.y, name: player.name, clan: player.clan, color: player.color, w: player.w, h: player.h });

  // camera
  camX = W/2 - player.px;
  camY = H/2 - player.py;

  // clear
  ctx.fillStyle = '#1b2a2b';
  ctx.fillRect(0,0,W,H);

  // draw visible tile range
  const startTx = Math.floor((-camX) / tileSize) - 1;
  const endTx = Math.floor((W - camX) / tileSize) + 1;
  const startTy = Math.floor((-camY) / tileSize) - 1;
  const endTy = Math.floor((H - camY) / tileSize) + 1;

  for(let tx = startTx; tx <= endTx; tx++){
    for(let ty = startTy; ty <= endTy; ty++){
      const key = worldKey(tx,ty);
      const tile = mapTiles[key];
      if(tile){
        const b = BLOCKS.find(bb => bb.id === tile.type);
        const img = tex[b.tex];
        if(img && img.complete) ctx.drawImage(img, tx*tileSize + camX, ty*tileSize + camY, tileSize, tileSize);
        else {
          // Fallback colors for missing textures
          ctx.fillStyle = b.id === 'carpet' ? '#8B4513' : 
                         b.id === 'blood' ? '#8B0000' : 
                         b.solid ? '#555' : '#3a3';
          ctx.fillRect(tx*tileSize + camX, ty*tileSize + camY, tileSize, tileSize);
        }
      } else {
        // background grass
        const g = tex['grass'];
        if(g && g.complete) ctx.drawImage(g, tx*tileSize + camX, ty*tileSize + camY, tileSize, tileSize);
        else { ctx.fillStyle = '#234'; ctx.fillRect(tx*tileSize + camX, ty*tileSize + camY, tileSize, tileSize); }
      }
    }
  }

  // draw other players
  for(const id in players){
    const p = players[id];
    if(!p) continue;
    const pw = p.w || 32, ph = p.h || 32;
    const imgP = tex['player'];
    const drawX = (p.px || 0) + camX;
    const drawY = (p.py || 0) + camY;
    if(imgP && imgP.complete) ctx.drawImage(imgP, drawX, drawY, pw, ph);
    else { ctx.fillStyle = p.color || '#44a'; ctx.fillRect(drawX, drawY, pw, ph); }
    const displayName = (p.clan ? '[' + p.clan + '] ' : '') + (p.name || 'Speler');
    ctx.fillStyle = 'white'; ctx.font = '12px sans-serif'; ctx.textAlign = 'center';
    ctx.fillText(displayName, drawX + pw/2, drawY - 6);

    // admin tracking lines
    if(local.id === adminId && adminTrack.checked && id !== local.id){
      ctx.strokeStyle = 'yellow'; ctx.beginPath();
      ctx.moveTo(player.px + camX + player.w/2, player.py + camY + player.h/2);
      ctx.lineTo(drawX + pw/2, drawY + ph/2); ctx.stroke();
    }
  }

  // local player drawn on top
  const lpImg = tex['player'];
  if(lpImg && lpImg.complete) ctx.drawImage(lpImg, player.px + camX, player.py + camY, player.w, player.h);
  else { ctx.fillStyle = player.color; ctx.fillRect(player.px + camX, player.py + camY, player.w, player.h); }
  ctx.fillStyle='white'; ctx.font='12px sans-serif'; ctx.textAlign='center';
  ctx.fillText((player.clan ? '['+player.clan+'] ' : '') + player.name, player.px + camX + player.w/2, player.py + camY - 6);

  coordsLabel.innerText = 'X:' + player.x + ' Y:' + player.y;
  playerLabel.innerText = 'Naam: ' + (player.clan ? '[' + player.clan + '] ' : '') + player.name;
  clanLabel.innerText = 'Clan: ' + (player.clan || '-');

  requestAnimationFrame(mainLoop);
}

/* check players colliding with tile */
function isAnyPlayerOnTile(tx,ty){
  for(const id in players){
    const p = players[id];
    if(!p) continue;
    const cx = Math.floor(((p.px || 0) + (p.w || 32)/2) / tileSize);
    const cy = Math.floor(((p.py || 0) + (p.h || 32)/2) / tileSize);
    if(cx === tx && cy === ty) return true;
  }
  if(player){
    const cx = Math.floor((player.px + player.w/2) / tileSize);
    const cy = Math.floor((player.py + player.h/2) / tileSize);
    if(cx === tx && cy === ty) return true;
  }
  return false;
}

/* ================= Startup ================= */
function init(){
  // build inventory (nothing selected by default)
  buildInventoryUI();
  selectedBlock = null;

  // if first time, show first modal
  if(isFirstTime()){
    show(firstModal);
    db.ref('clans').once('value').then(snap => { clans = snap.val() || {}; buildFirstModalClanList(); });
  } else {
    // load local settings
    local.nickname = localStorage.getItem('nickname');
    local.clan = localStorage.getItem('clan') || null;
    startOrUpdatePlayer();
  }
}

/* when player finishes first modal? */
async function startOrUpdatePlayer(){
  // ensure id
  if(localStorage.getItem('playerId')) local.id = localStorage.getItem('playerId');
  else { local.id = 'u_' + Math.random().toString(36).substr(2,6); localStorage.setItem('playerId', local.id); }
  // nickname & clan from localStorage
  if(local.nickname === null || typeof local.nickname === 'undefined') local.nickname = localStorage.getItem('nickname');
  if(!local.nickname) local.nickname = nickInput.value.trim() || 'Speler' + Math.floor(Math.random()*9999);
  localStorage.setItem('nickname', local.nickname);
  if(!local.clan) local.clan = localStorage.getItem('clan') || null;

  player = {
    px: 0, py: 0, x: 0, y: 0,
    speed: 4, w: 32, h: 32,
    color: '#ff4444',
    name: local.nickname,
    clan: local.clan || null
  };

  // push to firebase
  await db.ref('players/' + local.id).set(player);
  db.ref('players/' + local.id).onDisconnect().remove();

  // if clan selected, add to clan members
  if(local.clan) await db.ref('clans/' + local.clan + '/members/' + local.id).set({ name: local.nickname, joinedAt: Date.now() });

  updateLabels();
  requestAnimationFrame(mainLoop);
}

/* Finish flow for first modal "Klaar" */
firstDoneBtn.addEventListener('click', ()=>{
  const nick = nickInput.value.trim();
  if(!nick) return showNotification('Voer een bijnaam in.', 2000);
  local.nickname = nick; localStorage.setItem('nickname', nick);
  // if user typed clan name in newClanInput treat that as create
  const newClan = newClanInput.value.trim();
  if(newClan){
    // check duplicate
    const existing = Object.keys(clans || {}).find(c => c.toLowerCase() === newClan.toLowerCase());
    if(existing) { showNotification('Die clan bestaat al. Kies een andere naam of join een bestaande clan.', 3000); return; }
    // create and join
    db.ref('clans/' + newClan + '/members/' + (local.id || 'temp')).set({ name: nick, joinedAt: Date.now() });
    local.clan = newClan; localStorage.setItem('clan', newClan);
  }
  hide(firstModal);
  startOrUpdatePlayer();
});

/* If user uses join button in first modal (join known clan) call joinClan */
function joinClan(name){
  // if local.id not yet created, store choice; it will be applied after startOrUpdatePlayer
  local.clan = name; localStorage.setItem('clan', name);
  if(local.id){
    db.ref('clans/' + name + '/members/' + local.id).set({ name: local.nickname || player.name, joinedAt: Date.now() });
    if(player){ player.clan = name; db.ref('players/' + local.id + '/clan').set(name); }
    showNotification('Joined clan ' + name, 2000);
    updateLabels();
  } else {
    showNotification('Je clan wordt ingesteld zodra je klaar bent (na het invoeren van je bijnaam).', 3000);
  }
}

/* build first modal clan list helper (called when clans updated) */
function buildFirstModalClanList(){
  clanListEl.innerHTML = '';
  const names = Object.keys(clans || {});
  if(names.length === 0){
    const p = document.createElement('div'); p.className='small muted'; p.innerText = 'Nog geen clans.';
    clanListEl.appendChild(p); return;
  }
  names.sort((a,b)=>a.localeCompare(b, undefined, {sensitivity:'base'}));
  names.forEach(name=>{
    const el = document.createElement('div'); el.className='clan-item';
    const t = document.createElement('div'); t.style.fontWeight='700'; t.innerText = name;
    const m = document.createElement('div'); m.className='small muted'; m.innerText = 'Leden: ' + (clans[name].members ? Object.keys(clans[name].members).length : 0);
    const btn = document.createElement('button'); btn.style.marginTop='6px'; btn.innerText='Join'; btn.onclick = ()=> joinClan(name);
    el.appendChild(t); el.appendChild(m); el.appendChild(btn);
    clanListEl.appendChild(el);
  });
}

/* ================= Init ================= */
init();

</script>
</body>
</html>
